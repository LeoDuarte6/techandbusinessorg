---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { client as sanityClient, urlFor } from '../../lib/sanity';
import { PortableText } from 'astro-portabletext';
import ArticleCard from '../../components/ArticleCard.astro';

export async function getStaticPaths() {
  const posts = await sanityClient.fetch(`*[_type == "post"]{slug}`);
  
  return posts.map((post) => ({
    params: { slug: post.slug.current },
  }));
}

const { slug } = Astro.params;

// Fetch current post
const query = `*[_type == "post" && slug.current == $slug][0]{
  title,
  slug,
  mainImage,
  publishedAt,
  excerpt,
  body,
  "author": author->{name, slug, headshot, bio, role},
  readTime
}`;

const post = await sanityClient.fetch(query, { slug });

if (!post) {
  return Astro.redirect('/404');
}

// Fetch related articles (latest 3 excluding current)
const relatedQuery = `*[_type == "post" && slug.current != $slug] | order(publishedAt desc)[0...3] {
  title,
  slug,
  mainImage,
  publishedAt,
  excerpt,
  "author": author->{name, slug, headshot},
  readTime
}`;

const relatedArticles = await sanityClient.fetch(relatedQuery, { slug });

const imageUrl = post.mainImage ? urlFor(post.mainImage).width(1200).height(675).url() : null;
const formattedDate = new Date(post.publishedAt).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<BaseLayout title={`${post.title} | Tech & Business`} description={post.excerpt}>
  <!-- Reading Progress Bar -->
  <div class="fixed top-0 left-0 w-full h-1 z-[60]">
    <div id="reading-progress" class="h-full bg-[var(--theme-text)] w-0 transition-all duration-150"></div>
  </div>

  <article class="min-h-screen bg-[var(--theme-bg)] text-[var(--theme-text)] transition-colors duration-300">
    <!-- Article Header Section -->
    <div class="max-w-3xl mx-auto px-4 pt-12 pb-8">
      <!-- Breadcrumbs -->
      <nav class="flex items-center gap-2 text-sm text-[var(--theme-gray)] mb-4">
        <a href="/" class="hover:text-[var(--theme-text)] transition-colors">Home</a>
        <span>&rsaquo;</span>
        <a href="/articles" class="hover:text-[var(--theme-text)] transition-colors">Articles</a>
        <span>&rsaquo;</span>
        <span class="text-[var(--theme-text)] line-clamp-1">{post.title}</span>
      </nav>

      <!-- Title & Meta -->
      <h1 class="text-3xl md:text-5xl font-bold mb-3 leading-tight text-[var(--theme-text)]">
        {post.title}
      </h1>

      <div class="flex items-center gap-4 text-[var(--theme-gray)] mb-6 pb-6 border-b border-[var(--theme-border)]">
        {post.author && (
          <div class="flex items-center gap-3">
            {post.author.headshot ? (
              <img 
                src={urlFor(post.author.headshot).width(100).height(100).url()} 
                alt={post.author.name}
                class="w-12 h-12 rounded-full object-cover border border-[var(--theme-border)]"
              />
            ) : (
              <div class="w-12 h-12 rounded-full bg-[var(--theme-gray-light)] flex items-center justify-center text-[var(--theme-gray)] font-bold text-lg">
                {post.author.name.charAt(0)}
              </div>
            )}
            <div>
              <div class="font-bold text-[var(--theme-text)] text-lg leading-none mb-1">
                {post.author.name}
              </div>
              <div class="text-sm text-[var(--theme-gray)] flex items-center gap-2">
                <time datetime={post.publishedAt}>{formattedDate}</time>
                <span>&bull;</span>
                <span>{post.readTime || 5} min read</span>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>

    <!-- Featured Image (Full Width Container, Max Width Image) -->
    {imageUrl && (
      <div class="w-full max-w-4xl mx-auto px-4 mb-12">
        <img 
          src={imageUrl} 
          alt={post.title}
          class="w-full h-auto rounded-xl shadow-sm"
        />
      </div>
    )}

    <!-- Article Content -->
    <div class="max-w-3xl mx-auto px-4 pb-20">
      <div 
        class="prose prose-lg max-w-none
               prose-headings:font-bold prose-headings:text-[var(--theme-text)] prose-headings:tracking-tight
               prose-h1:hidden
               prose-h2:text-3xl prose-h2:mt-12 prose-h2:mb-6
               prose-h3:text-2xl prose-h3:mt-8 prose-h3:mb-4
               prose-a:text-[var(--theme-text)] prose-a:underline prose-a:decoration-[var(--theme-border)] prose-a:underline-offset-4 hover:prose-a:decoration-[var(--theme-text)] hover:prose-a:text-[var(--theme-text)]
               prose-blockquote:border-l-4 prose-blockquote:border-[var(--theme-text)] prose-blockquote:pl-6 prose-blockquote:italic prose-blockquote:text-[var(--theme-gray)] prose-blockquote:bg-[var(--theme-gray-light)] prose-blockquote:py-2 prose-blockquote:pr-4
               prose-strong:text-[var(--theme-text)] prose-strong:font-bold
               prose-img:rounded-xl prose-img:shadow-sm"
      >
        <PortableText value={post.body} />
      </div>

      <!-- Bottom Action Bar (Like Beehiiv) -->
      <div class="mt-16 pt-8 border-t border-[var(--theme-border)] flex items-center justify-between text-[var(--theme-gray)]">
        <div class="flex items-center gap-6">
          <button class="flex items-center gap-2 hover:text-[var(--theme-text)] transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
            <span>Like</span>
          </button>
          <button class="flex items-center gap-2 hover:text-[var(--theme-text)] transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            <span>Comment</span>
          </button>
        </div>
        <button class="flex items-center gap-2 hover:text-[var(--theme-text)] transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg>
          <span>Share</span>
        </button>
      </div>

      <!-- Author Bio Box -->
      {post.author && post.author.bio && (
        <div class="mt-12 bg-[var(--theme-gray-light)] p-8 rounded-xl border border-[var(--theme-border)] flex items-start gap-6">
          {post.author.headshot && (
            <img 
              src={urlFor(post.author.headshot).width(120).height(120).url()} 
              alt={post.author.name}
              class="w-20 h-20 rounded-full object-cover border border-[var(--theme-border)] shadow-sm flex-shrink-0"
            />
          )}
          <div>
            <h3 class="text-xl font-bold text-[var(--theme-text)] mb-2">{post.author.name}</h3>
            {post.author.role && (
              <p class="text-xs font-bold text-[var(--theme-gray)] uppercase tracking-wider mb-3">
                {post.author.role}
              </p>
            )}
            <p class="text-[var(--theme-text)] leading-relaxed">
              {post.author.bio}
            </p>
          </div>
        </div>
      )}
    </div>
  </article>

  <!-- Related Articles Section -->
  <section class="section-padding bg-[var(--theme-gray-light)] border-t-2 border-white transition-colors duration-300">
    <div class="container-custom">
      <h2 class="mb-8 text-[var(--theme-text)]">Keep Reading</h2>
      <div class="grid md:grid-cols-3 gap-6">
        {relatedArticles.map((article) => (
          <a href={`/articles/${article.slug.current}`} class="group block bg-[var(--theme-bg)] border border-[var(--theme-border)] rounded-xl p-6 hover:border-[var(--theme-text)] transition-colors">
            <h3 class="text-lg font-bold text-[var(--theme-text)] mb-2 group-hover:underline decoration-2 underline-offset-4">
              {article.title}
            </h3>
            {article.excerpt && (
              <p class="text-sm text-[var(--theme-gray)] line-clamp-2 mb-4">
                {article.excerpt}
              </p>
            )}
            <div class="flex items-center gap-2 text-xs text-[var(--theme-gray)] font-medium uppercase tracking-wider">
              <span>Read Article</span>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:translate-x-1 transition-transform"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- Reading Progress Script -->
  <script>
    function updateReadingProgress() {
      const article = document.querySelector('article');
      const progressBar = document.getElementById('reading-progress');
      
      if (!article || !progressBar) return;
      
      const windowHeight = window.innerHeight;
      const articleHeight = article.offsetHeight;
      const scrollTop = window.scrollY;
      
      // Calculate percentage
      const scrollPercentage = (scrollTop / (articleHeight - windowHeight)) * 100;
      const percentage = Math.max(0, Math.min(100, scrollPercentage));
      
      progressBar.style.width = `${percentage}%`;
    }
    
    window.addEventListener('scroll', updateReadingProgress);
    updateReadingProgress();
  </script>
</BaseLayout>
