---
import BaseLayout from '../layouts/BaseLayout.astro';
import ArticleCard from '../components/ArticleCard.astro';
import { client as sanityClient } from '../lib/sanity';

const query = `*[_type == "post"] | order(publishedAt desc) {
  title,
  slug,
  mainImage,
  publishedAt,
  excerpt,
  "author": author->{name, slug, headshot},
  readTime
}`;

const articles = await sanityClient.fetch(query);

// Get unique authors for filter
const authors = [...new Set(articles.map(a => a.author?.name).filter(Boolean))];
---

<BaseLayout title="Articles | Tech & Business">
  <section class="section-padding">
    <div class="container-custom">
      <div class="mb-12">
        <h1 class="mb-4 text-[var(--theme-text)]">Articles</h1>
        <p class="text-lg text-[var(--theme-gray)] max-w-2xl">
          In-depth analysis and commentary on technology, business, and finance.
        </p>
      </div>

      <!-- Filter and Sort Controls -->
      <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8 pb-6 border-b border-[var(--theme-border)]">
        <div class="flex items-center gap-2">
          <label for="author-filter" class="text-sm font-semibold text-[var(--theme-text)] whitespace-nowrap">Author:</label>
          <select 
            id="author-filter" 
            class="w-full sm:w-auto px-3 py-1.5 bg-[var(--theme-bg)] border border-[var(--theme-border)] text-[var(--theme-text)] text-sm rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--theme-text)]"
          >
            <option value="">All Authors</option>
            {authors.map(author => (
              <option value={author}>{author}</option>
            ))}
          </select>
        </div>

        <div class="flex items-center gap-2">
          <label for="sort-by" class="text-sm font-semibold text-[var(--theme-text)] whitespace-nowrap">Sort:</label>
          <select 
            id="sort-by" 
            class="w-full sm:w-auto px-3 py-1.5 bg-[var(--theme-bg)] border border-[var(--theme-border)] text-[var(--theme-text)] text-sm rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--theme-text)]"
          >
            <option value="date-desc">Newest</option>
            <option value="date-asc">Oldest</option>
            <option value="read-time-asc">Shortest</option>
            <option value="read-time-desc">Longest</option>
          </select>
        </div>
      </div>

      <div id="articles-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
        {articles.map((article) => (
          <ArticleCard {...article} />
        ))}
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  // Store articles data
  const articlesData = window.__ARTICLES_DATA__;
  const authorFilter = document.getElementById('author-filter') as HTMLSelectElement;
  const sortBy = document.getElementById('sort-by') as HTMLSelectElement;
  const articlesGrid = document.getElementById('articles-grid');

  function filterAndSort() {
    if (!articlesGrid) return;
    
    let filtered = [...articlesData];

    // Filter by author
    const selectedAuthor = authorFilter.value;
    if (selectedAuthor) {
      filtered = filtered.filter(a => a.author?.name === selectedAuthor);
    }

    // Sort
    const sortValue = sortBy.value;
    filtered.sort((a, b) => {
      switch (sortValue) {
        case 'date-desc':
          return new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime();
        case 'date-asc':
          return new Date(a.publishedAt).getTime() - new Date(b.publishedAt).getTime();
        case 'read-time-asc':
          return (a.readTime || 0) - (b.readTime || 0);
        case 'read-time-desc':
          return (b.readTime || 0) - (a.readTime || 0);
        default:
          return 0;
      }
    });

    // Re-render articles
    articlesGrid.innerHTML = filtered.map(article => {
      const imageUrl = article.mainImage?.asset?.url || '';
      const authorName = article.author?.name || 'Unknown';
      const authorSlug = article.author?.slug?.current || '';
      const date = new Date(article.publishedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      
      return `
        <article class="group">
          <a href="/articles/${article.slug.current}" class="block">
            ${imageUrl ? `
              <div class="aspect-video mb-4 overflow-hidden rounded-lg">
                <img 
                  src="${imageUrl}?w=600&h=400&fit=crop" 
                  alt="${article.title}"
                  class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                />
              </div>
            ` : ''}
            <h3 class="text-xl font-bold mb-2 text-[var(--theme-text)] group-hover:text-[var(--theme-gray)] transition-colors">
              ${article.title}
            </h3>
            <p class="text-[var(--theme-gray)] mb-4 line-clamp-2">
              ${article.excerpt || ''}
            </p>
            <div class="flex items-center gap-4 text-sm text-[var(--theme-gray)]">
              <span>${authorName}</span>
              <span>•</span>
              <span>${date}</span>
              ${article.readTime ? `
                <span>•</span>
                <span>${article.readTime} min read</span>
              ` : ''}
            </div>
          </a>
        </article>
      `;
    }).join('');
  }

  authorFilter?.addEventListener('change', filterAndSort);
  sortBy?.addEventListener('change', filterAndSort);
</script>

<script is:inline define:vars={{ articles }}>
  window.__ARTICLES_DATA__ = articles;
</script>
